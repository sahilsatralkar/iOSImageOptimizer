name: CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  test:
    name: Run Tests
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer
      
    - name: Cache Swift packages
      uses: actions/cache@v3
      with:
        path: |
          .build
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-swift-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-
    
    - name: Build project
      run: swift build
      working-directory: ./iOSImageOptimizer
      
    - name: Run unit tests
      run: swift test --enable-code-coverage
      working-directory: ./iOSImageOptimizer
      
    - name: Generate coverage report
      run: |
        xcrun llvm-cov export \
          ./.build/arm64-apple-macosx/debug/iOSImageOptimizerPackageTests.xctest/Contents/MacOS/iOSImageOptimizerPackageTests \
          -instr-profile=./.build/arm64-apple-macosx/debug/codecov/default.profdata \
          -format="lcov" > coverage.lcov
      working-directory: ./iOSImageOptimizer
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./iOSImageOptimizer/coverage.lcov
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
        
    - name: Test Results Summary
      if: always()
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… All 154 unit tests executed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š Code coverage report generated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Review test results in the Actions tab" >> $GITHUB_STEP_SUMMARY
        echo "- Check coverage report on Codecov" >> $GITHUB_STEP_SUMMARY